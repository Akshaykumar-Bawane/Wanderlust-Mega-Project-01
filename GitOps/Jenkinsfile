@Library('Shared') _
pipeline {
    agent { label 'vinod' }

    parameters {
        string(name: 'FRONTEND_DOCKER_TAG', defaultValue: '', description: 'Frontend Docker tag of the image built by the CI job')
        string(name: 'BACKEND_DOCKER_TAG', defaultValue: '', description: 'Backend Docker tag of the image built by the CI job')
    }

    stages {
        stage("Workspace cleanup") {
            steps {
                cleanWs()
            }
        }

        stage('Git: Code Checkout') {
            steps {
                script {
                    code_checkout("https://github.com/Akshaykumar-Bawane/Wanderlust-Mega-Project-01.git", "main")
                }
            }
        }

        stage('Update: Kubernetes manifests') {
            steps {
                script {
                    dir('kubernetes') {
                        sh """
                            sed -i 's|wanderlust-backend-beta:.*|wanderlust-backend-beta:${params.BACKEND_DOCKER_TAG}|g' backend.yaml
                            sed -i 's|wanderlust-frontend-beta:.*|wanderlust-frontend-beta:${params.FRONTEND_DOCKER_TAG}|g' frontend.yaml
                        """
                    }
                }
            }
        }

        stage("Git: Code update and push to GitHub") {
            steps {
                script {
                    withCredentials([gitUsernamePassword(credentialsId: 'Github-cred', gitToolName: 'Default')]) {
                        sh """
                            echo "Checking repo status..."
                            git status

                            echo "Adding modified files..."
                            git add kubernetes/*.yaml

                            echo "Committing changes..."
                            git commit -m "Updated Kubernetes manifests with new image tags"

                            echo "Pushing updates to GitHub..."
                            git push https://github.com/Akshaykumar-Bawane/Wanderlust-Mega-Project-01.git main
                        """
                    }
                }
            }
        }

        stage('Deploy to Minikube Cluster') {
            steps {
                script {
                    echo "Deploying to local Minikube cluster..."
                    sh """
                        kubectl apply -f kubernetes/backend.yaml
                        kubectl apply -f kubernetes/frontend.yaml

                        echo "\\nCurrent pods status:"
                        kubectl get pods -o wide

                        echo "\\nCurrent services:"
                        kubectl get svc -o wide
                    """
                }
            }
        }
    }

    post {
        success {
            emailext(
                attachLog: true,
                subject: "✅ Wanderlust deployed successfully to Minikube",
                body: """
                    <html><body>
                    <p><b>Deployment successful!</b></p>
                    <p>Backend Image: wanderlust-backend-beta:${params.BACKEND_DOCKER_TAG}</p>
                    <p>Frontend Image: wanderlust-frontend-beta:${params.FRONTEND_DOCKER_TAG}</p>
                    </body></html>
                """,
                to: 'messier877@gmail.com',
                mimeType: 'text/html'
            )
        }

        failure {
            emailext(
                attachLog: true,
                subject: "❌ Wanderlust deployment failed on Minikube",
                body: "Please check Jenkins logs for details.",
                to: 'messier877@gmail.com'
            )
        }
    }
}

